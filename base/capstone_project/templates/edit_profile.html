{% extends 'base.html' %}
{% block content %}
<div class="container">
    <h1>Edit Your Profile</h1>
    {% if error %}
        <p class="message error-message">{{ error }}</p>
    {% endif %}
    {% if success %}
        <p class="message success-message">{{ success }}</p>
    {% endif %}
    <form method="post" enctype="multipart/form-data" id="profileForm">
        {% csrf_token %}
        <label for="first_name">First Name:</label>
        <input type="text" id="first_name" name="first_name" value="{{ user.first_name }}" required>
        <label for="last_name">Last Name:</label>
        <input type="text" id="last_name" name="last_name" value="{{ user.last_name }}" required>
        <label for="username">Username:</label>
        <input type="text" id="username" name="username" value="{{ user.username }}" required>
        <label for="password">New Password (leave blank to keep current):</label>
        <input type="password" id="password" name="password" placeholder="Enter new password">
        <label for="address">Address:</label>
        <input type="text" id="address" name="address" value="{{ user.address|default:'' }}">
        <label for="contact_number">Contact Number:</label>
        <input type="text" id="contact_number" name="contact_number" value="{{ user.contact_number|default:'' }}" maxlength="15">
        <label for="profile_picture">Profile Picture:</label>
        <input type="file" id="profile_picture" name="profile_picture" accept="image/*">
        <div id="imagePreview" style="display: none; margin-top: 10px;">
            <img id="image" style="max-width: 100%;">
        </div>
        <input type="hidden" id="cropped_image" name="cropped_image">
        <button type="submit">Save Changes</button>
    </form>
    {% if user.profile_picture %}
        <p>Current Picture: <img src="{{ user.profile_picture.url }}" alt="Profile Picture" class="profile-pic"></p>
    {% endif %}
    <a href="{% url 'dashboard' %}">Back to Dashboard</a>
</div>

<!-- Include Cropper.js -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>

<style>
.message {
    font-size: 16px;
    padding: 10px;
    margin-bottom: 15px;
    border-radius: 5px;
    text-align: center;
}
.success-message {
    color: #155724;
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
}
.error-message {
    color: #721c24;
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
}
input[type="file"] {
    margin-bottom: 10px;
}
.profile-pic {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 50%;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('profile_picture');
    const image = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');
    const croppedImageInput = document.getElementById('cropped_image');
    let cropper;

    input.addEventListener('change', function (e) {
        const files = e.target.files;
        if (files && files.length > 0) {
            const reader = new FileReader();
            reader.onload = function (event) {
                image.src = event.target.result;
                imagePreview.style.display = 'block';
                if (cropper) {
                    cropper.destroy();
                }
                cropper = new Cropper(image, {
                    aspectRatio: 1,
                    viewMode: 1,
                    autoCropArea: 0.8,
                    movable: true,
                    zoomable: true,
                    scalable: false,
                    crop: function (event) {
                        const canvas = cropper.getCroppedCanvas({
                            width: 200,
                            height: 200,
                        });
                        croppedImageInput.value = canvas.toDataURL('image/jpeg');
                    }
                });
            };
            reader.readAsDataURL(files[0]);
        }
    });

    document.getElementById('profileForm').addEventListener('submit', function (e) {
        if (cropper) {
            const canvas = cropper.getCroppedCanvas({
                width: 200,
                height: 200,
            });
            croppedImageInput.value = canvas.toDataURL('image/jpeg');
        }
    });
});
</script>
{% endblock %}